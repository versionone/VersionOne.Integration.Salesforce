<!-- Page -->
<apex:page controller="SettingsController" action="{!initSettings}" title="VersionOne Integration Settings">
    <script type="text/javascript">
        function disableAllButtons() {
            disableSaveButtons();
            disableTestButtons();
        }
        function disableSaveButtons() {
            disableSaveButton1();
            disableSaveButton2();
        }
        function disableTestButtons() {
            disableTestButton1();
            disableTestButton2();
        }
        function disableElement(ele) {
            ele.disabled = true;
            ele.className = 'btnDisabled';
        }

    </script>
    <apex:sectionHeader title="Settings for VersionOne integration." />

    <apex:actionStatus startText="Testing settings..." id="test_status" />
    <apex:actionStatus startText="Saving settings..." id="save_status" />
    <apex:actionStatus startText="Updating project..." id="update_project" />
    <apex:actionStatus startText="Additing mapping ..." id="addMapping" />
    <apex:form >
        <apex:pageBlock title="Connection settings" mode="edit">
            <apex:pageBlockSection columns="1">
                <!-- title="Connection" -->
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="{!settings.pathTitle}" for="V1Path" />
                    <c:inputRequiredText value="{!settings.path}" size="75" id="V1Path"
                        tabindex="1" onkeydown="disableSaveButtons();" onchange="disableSaveButtons();" maxlength="255"/>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="{!settings.UserNameTitle}" for="UserName" />
                    <c:inputRequiredText value="{!settings.UserName}" size="40"
                        id="UserName" tabindex="2"
                        onkeydown="disableSaveButtons();" onchange="disableSaveButtons();" maxlength="20"/>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="{!settings.PasswordTitle}" for="Password" />
                    <apex:outputPanel styleClass="requiredInput" layout="block">
                        <apex:outputPanel styleClass="requiredBlock" layout="block"/>
                        <apex:inputSecret value="{!settings.Password}" size="40" redisplay="true"
                            id="Password" tabindex="3" onkeydown="disableSaveButtons();" onchange="disableSaveButtons();" maxlength="20"/>
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="{!settings.SourceTitle}" for="Source" />
                    <c:inputRequiredText value="{!settings.Source}" size="40"
                        id="Source" tabindex="4"
                        onkeydown="disableSaveButtons();" onchange="disableSaveButtons();" maxlength="30"/>
                </apex:pageBlockSectionItem>
            </apex:pageBlockSection>
            <apex:pageBlockButtons location="top">
                <apex:commandButton value="Save settings" action="{!saveSettings}"
                    disabled="{!isSettingsCorrect == false}" id="save_button1"
                    onclick="disableAllButtons();" status="save_status"
                    rerender="out_testing, out_saving, message_test, message_save, save_button1, save_button2, test_button1, test_button2, messages, ProjectMapping">
                    <script type="text/javascript">
                        function disableSaveButton1() {
	                        disableElement(document.getElementById('{!$Component.save_button1}'));
    	                }
                	</script>
                </apex:commandButton>
                <apex:commandButton value="Test settings" action="{!testSettings}"
                    rerender="out_testing, out_saving, message_test, messge_save, save_button1, save_button2, test_button1, test_button2, messages"
                    onclick="disableAllButtons()"
                    status="test_status" id="test_button1">
                    <script type="text/javascript">
                        function disableTestButton1() {
                            disableElement(document.getElementById('{!$Component.test_button1}'));
                        }
                	</script>
                </apex:commandButton>
            </apex:pageBlockButtons>
            <apex:pageBlockButtons location="bottom">
                <apex:commandButton value="Save settings" action="{!saveSettings}"
                    disabled="{!isSettingsCorrect == false}" id="save_button2"
                    onclick="disableAllButtons();" status="save_status"
                    rerender="out_testing, out_saving, message_test, message_save, save_button1, save_button2, test_button1, test_button2, messages, ProjectMapping">
                    <script type="text/javascript">
                    function disableSaveButton2() {
                        disableElement(document.getElementById('{!$Component.save_button2}'));
                    }
                	</script>
                </apex:commandButton>
                <apex:commandButton value="Test settings" action="{!testSettings}"
                    rerender="out_testing, out_saving, message_test, message_save, save_button1, save_button2, test_button1, test_button2, messages"
                    onclick="disableAllButtons()"
                    status="test_status" id="test_button2">
                    <script type="text/javascript">
                        function disableTestButton2() {
                        disableElement(document.getElementById('{!$Component.test_button2}'));
                    }
                	</script>
                </apex:commandButton>
            </apex:pageBlockButtons>
        </apex:pageBlock>
        <apex:pageBlock title="VersionOne Project for Defect Creation" id="ProjectMapping">
            <apex:pageBlockSection rendered="{!isGotProjects}" columns="1">
                <apex:pageBlockSectionItem >
	                <apex:outputLabel value="SalesForce product" for="ProductId" />
                    <apex:selectList size="1" required="false" id="ProductId" value="{!currectMapping.productId}">
                        <apex:selectOptions value="{!ProductList}"/>
                    </apex:selectList>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
	                <apex:outputLabel value="VersionOne project" for="ProjectToken" />
					<apex:outputPanel layout="block">
						<apex:selectList value="{!currectMapping.projectToken}" size="1" required="false" id="ProjectToken">
						    <apex:selectOptions value="{!VersionOneProjectsList}"/>
						</apex:selectList>
						&nbsp;&nbsp;&nbsp;
						<apex:commandButton value="Add" action="{!addMapping}" rerender="ProjectMapping" status="addMapping"/>
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
			    <apex:pageBlockSectionItem >
			        <apex:pageBlockTable value="{!mappings}" var="mapping">
						<apex:column >
							<apex:facet name="header">Actions</apex:facet>
			                <apex:outputLink onclick="javascript: UpdateProject('{!mapping.mappingId}');"
		 		                   value="javascript:return false;">Update</apex:outputLink>
	            		    &nbsp;&nbsp;
			                <apex:outputLink onclick="javascript: UpdateProject();"
		 		                   value="javascript:return false;" rendered="{!mapping.isDeletable}">Remove</apex:outputLink>
						</apex:column>
						<apex:column >
							<apex:facet name="header">VersionOne Project</apex:facet>
							<apex:outputText value="{!mapping.projectName}"/>
						</apex:column>
						<apex:column >
							<apex:facet name="header">SalesForce Product</apex:facet>
							<apex:outputText value="{!mapping.productName}"/>
						</apex:column>
						<apex:column >
							<apex:facet name="header">Visible</apex:facet>
							<apex:outputText value="{!IF((mapping.isVisible),'Yes','No')}"/>
						</apex:column>
 			        </apex:pageBlockTable>
			    </apex:pageBlockSectionItem>

            </apex:pageBlockSection>
        </apex:pageBlock>

		<apex:actionFunction name="UpdateProject" action="{!updateDefaultProject}" status="update_project" rerender="ProjectMapping">
			<apex:param name="mappingId" value=""/>
		</apex:actionFunction>
    </apex:form>

    <apex:outputPanel id="out_testing">
        <apex:pageMessage severity="{!testSeverity}" id="message_test"
            title="Testing result" summary="{!testMessage}"
            rendered="{!isSettingsValidated}" strength="1" />
    </apex:outputPanel>

    <apex:outputPanel id="out_saving">
        <apex:pageMessage severity="{!saveSeverity}" id="message_save"
            title="Saving result" summary="{!saveMessage}" rendered="{!isSaved}"
            strength="1" />
    </apex:outputPanel>

    <apex:pageMessages id="messages" />
</apex:page>